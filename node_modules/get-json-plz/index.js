var http = require('http')
var https = require('https')
var url = require('url')

// Easy way to GET the JSON response of a URL.
// Works with `yield` as well as with a normal callback.
// var json = yield get('http://hostname.com/data.json')
module.exports = function (uri, done) {
  var options = url.parse(uri)
  options.agent = false
  options.headers = {
    'Accept': 'application/json',
    'User-Agent': 'jonathanong/get-json-plz'
  }

  var req = (options.protocol === 'https:' ? https : http).request(options)
  req.once('response', onResponse)
  req.once('error', onFinish)
  req.end()

  return function (fn) {
    done = fn
  }

  function onResponse(res) {
    if (res.statusCode !== 200) {
      res.resume() // dump the response
      onFinish()
      return
    }

    var body = ''
    res.setEncoding('utf8')
    res.on('data', onData)
    res.once('end', onEnd)

    function onData(chunk) {
      body += chunk
    }

    function onEnd() {
      try {
        body = JSON.parse(body)
      } catch (err) {
        onFinish(err)
        return
      }

      onFinish(null, body)
      res.removeListener('data', onData)
    }
  }

  function onFinish(err, body) {
    done(err, body)
    cleanup()
  }

  function cleanup() {
    req.removeListener('error', done)
    req.removeListener('response', onResponse)
  }
}